<project name="Parser" default="install">
  <property name="czt.home" location=".."/>
  <property file="${czt.home}/czt.properties"/>
  <property name="czt.lib" location="${czt.home}/${jar.dir}"/>
  <property name="parser.jar.dir" location="${czt.home}/${jar.dir}"/>
  <property name="jar.file" location="${parser.jar.dir}/${parser.jar.file}"/>
  <property name="src.dir" location="src"/>
  <property name="build.dir" location="build"/>
  <property name="api.dir" location="doc/api"/>
  <property name="oz.package.dir" location="${src.dir}/net/sourceforge/czt/parser/oz"/>
  <property name="oz.scanner.name" value="LatexScanner"/>
  <property name="oz.parser.name" value="Parser"/>
  <property name="oz.sym.name" value="Sym"/>

  <taskdef classname="ant.JavaCupTask" name="java_cup"
    classpath="${czt.home}/${jar.dir}/${java_cup.task.jar}"/>
  <taskdef classname="JFlex.anttask.JFlexTask" name="jflex"
    classpath="${jflex.jar}"/>

  <path id="classpath">
    <pathelement path="${jwsdp.classpath}"/>
    <fileset dir="${czt.lib}">
      <include name="${corejava.base.jar.file}"/>
      <include name="${corejava.core.jar.file}"/>
      <include name="${corejava.oz.jar.file}"/>
      <include name="${corejava.jaxb.jar.file}"/>
    </fileset>
    <pathelement path="${java.class.path}"/>
  </path>

  <target name="init">
    <tstamp/>
    <mkdir dir="${build.dir}"/>
  </target>

  <target name="all" depends="install, doc"
    description="build the jar files and the documentation"/>

  <target name="install" depends="compile"
          description="build and install the jar files">
    <mkdir dir="${parser.jar.dir}"/>
    <jar jarfile="${jar.file}">
      <fileset dir="${build.dir}"/>
    </jar>
  </target>

  <target name="scanner">
    <jflex
      file="src/net/sourceforge/czt/scanner/unicode.jflex"
      destdir="${src.dir}"/>
    <jflex
      file="src/net/sourceforge/czt/scanner/latex2unicode.jflex"
      destdir="${src.dir}"/>
  </target>

  <target name="LatexToUnicode">
    <javacc 
      target="src/net/sourceforge/czt/scanner/LatexToUnicode.jj"
      javacchome="${javacc.home}"/>
  </target>

  <target name="UnicodeToLatex">
    <java_cup
      srcDir="src/net/sourceforge/czt/scanner"
      destDir="src/net/sourceforge/czt/scanner"
      inputFile="unicode2latex.cup"
      parserFile="Unicode2Latex"
      symbolFile="sym"
    />
  </target>

  <target name="latexMarkup">
    <xslt
      in="xsl/latexMarkup.xml"
      out="${src.dir}/net/sourceforge/czt/scanner/LatexMarkup.java"
      style="xsl/latexMarkup2class.xsl"/>
  </target>

  <target name="compile" depends="init, scanner, latexMarkup, LatexToUnicode, UnicodeToLatex, oz-parser, old-scanner, uscanner"
          description="compile the sources">
    <javac srcdir="${src.dir}"
           destdir="${build.dir}"
           debug="true">
      <classpath refid="classpath"/>
    </javac>
  </target>

  <target name="oz-parser">
    <java_cup
      srcDir="${oz.package.dir}/"
      destDir="${oz.package.dir}/"
      inputFile="${parser.name}.cup"
      parserFile="${parser.name}"
      symbolFile="${sym.name}"
    />
  </target>

  <target name="old-scanner" description="Create the old object Z scanner">
    <jflex file="${oz.package.dir}/${oz.scanner.name}.flex"
      destdir="${src.dir}/"
      skipMinimization="yes"
    />
  </target>

  <target name="uscanner" description="Create the unicode scanner for the object Z parser">
    <jflex file="${oz.package.dir}/UnicodeScanner.jflex"
      destdir="${src.dir}/"
      skipMinimization="yes"
    />
  </target>

  <target name="printclasspath">
      <pathconvert targetos="unix" property="tmp.clspath"
            refid="classpath">
    </pathconvert>
    <echo message="CLASSPATH = ${tmp.clspath}"/>
  </target>

  <target name="run" depends="install" description="Run the GUI for the object Z parser">
    <java classname="${package.name}.Main" fork="true">
      <classpath refid="classpath"/>
    </java>
  </target>

  <target name="scan" depends="install" if="file"
    description="Scans an unicode file (provide a file name by setting property 'file' using the -D option)">
    <java classname="net.sourceforge.czt.scanner.UnicodeLexer" fork="true">
      <arg value="${file}"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${jar.file}"/>
      </classpath>
    </java>
  </target>

  <target name="latex2unicode" depends="install" if="file"
    description="Transforms a latex specification into unicode (provide a file name by setting property 'file' using the -D option)">
    <java classname="net.sourceforge.czt.scanner.LatexToUnicode" fork="true">
      <arg value="${file}"/>
      <classpath>
        <path refid="classpath"/>
        <pathelement location="${jar.file}"/>
      </classpath>
    </java>
  </target>

  <target name="doc" depends="api"
    description="build all the documentation"/>

  <target name="api"
          description="build the API documentation">
    <mkdir dir="${api.dir}"/>
    <javadoc
      destdir="${api.dir}"
      private="true">
      <packageset dir="${src.dir}">
        <include name="net/sourceforge/czt/scanner/**"/>    
      </packageset>
      <tag name="czt.todo" description="To do:"/>
      <classpath refid="classpath"/>
    </javadoc>
  </target>

  <target name="test" depends="install"
    description="build and run the tests">
    <ant dir="tests"/>
  </target>

  <target name="checkstyle" description="check java sources">
    <taskdef resource="checkstyletask.properties"
      classpath="${checkstyle.jar}"/>
    <checkstyle config="${czt.home}/devtools/checkstyle.xml">
      <fileset dir="${src.dir}">
        <exclude name="net/sourceforge/czt/parser/**"/>
      </fileset>
      <fileset dir="tests/src"/>
      <formatter type="plain"/>
    </checkstyle>
  </target>

  <target name="clean"
          description="clean up">
    <delete dir="${build.dir}"/>
    <delete dir="${api.dir}"/>
    <delete file="${oz.package.dir}/${oz.scanner.name}.java"/>
    <delete file="${oz.package.dir}/UnicodeScanner.java"/>
    <delete file="${oz.package.dir}/${oz.parser.name}.java"/>
    <delete file="${oz.package.dir}/${oz.sym.name}.java"/>
    <delete file="src/net/sourceforge/czt/scanner/Unicode2Latex.java"/>
    <delete file="src/net/sourceforge/czt/scanner/UnicodeLexer.java"/>
    <delete file="src/net/sourceforge/czt/scanner/UnicodeLexer.java~"/>
    <delete file="src/net/sourceforge/czt/scanner/Latex2Unicode.java~"/>
    <delete file="src/net/sourceforge/czt/scanner/Latex2Unicode.java~"/>
    <delete file="src/net/sourceforge/czt/scanner/Latex2Unicode.java"/>
    <delete file="src/net/sourceforge/czt/scanner/Latex2Unicode.java~"/>
    <delete file="src/net/sourceforge/czt/scanner/LatexMarkup.java"/>
    <delete file="src/net/sourceforge/czt/scanner/LatexToUnicode.java"/>
    <delete file="src/net/sourceforge/czt/scanner/LatexToUnicodeConstants.java"/>
    <delete file="src/net/sourceforge/czt/scanner/LatexToUnicodeTokenManager.java"/>
    <delete file="src/net/sourceforge/czt/scanner/ParseException.java"/>
    <delete file="src/net/sourceforge/czt/scanner/SimpleCharStream.java"/>
    <delete file="src/net/sourceforge/czt/scanner/Token.java"/>
    <delete file="src/net/sourceforge/czt/scanner/TokenMgrError.java"/>
    <exec executable="make">
      <arg value="clean"/>
    </exec>
    <ant dir="tests" target="clean"/>
  </target>
</project>
