<project name="Typecheck" default="install">
  <property name="czt.home" location="../"/>
  <property file="${czt.home}/czt.properties"/>
  <property name="typecheck.jar.dir" location="${czt.home}/${jar.dir}"/>
  <property name="typecheck.jar.file" location="${typecheck.jar.dir}/${typechecker.jar.file}"/>
  <property name="typecheck.src.jar.file"  location="${typecheck.jar.dir}/src-${typechecker.jar.file}"/>
  <property name="typecheck.api.src.jar.file"  location="${typecheck.jar.dir}/src-api-${typechecker.jar.file}"/>
  <property name="typecheck.src.dir" location="src"/>
  <property name="typecheck.build.dir" location="build"/>
  <property name="typecheck.api.dir" location="doc/api"/>

  <path id="classpath">
<!--    <pathelement path="${jwsdp.classpath}"/>-->
    <pathelement location="${typecheck.build.dir}"/>
    <pathelement location="${czt.home}/${jar.dir}/${util.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${corejava.core.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${corejava.jaxb.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${corejava.oz.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${corejava.tcoz.jar.file}"/>
	<pathelement location="${czt.home}/${jar.dir}/${corejava.circus.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${session.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${parser.jar.file}"/>
    <pathelement location="${czt.home}/${jar.dir}/${java_cup.jar.file}"/>    
    <pathelement location="${czt.home}/${jar.dir}/${typechecker.jar.file}"/>
    <pathelement path="${java.class.path}"/>
  </path>

  <target name="init">
    <tstamp/>
    <mkdir dir="${typecheck.build.dir}"/>
  </target>

  <target name="all" depends="install, doc"
    description="build the jar files and the documentation"/>

  <target name="install" depends="compile"
          description="build and install the jar files">
    <mkdir dir="${typecheck.jar.dir}"/>
    <jar jarfile="${typecheck.jar.file}">
      <fileset dir="${typecheck.build.dir}"/>
      <fileset dir="${typecheck.src.dir}">
        <include name="**/*.properties"/>
      </fileset>
    </jar>
  </target>

  <target name="compile" depends="init"
          description="compile the sources">
    <javac source="1.5"
           srcdir="${typecheck.src.dir}"
           destdir="${typecheck.build.dir}"
           debug="${debug}" debuglevel="${debuglevel}" optimize="${optimize}">
      <classpath refid="classpath"/>
<!--      <compilerarg value="-Xlint"/>-->
    </javac>
  </target>

  <target name="doc" depends="api"
    description="build all the documentation"/>

  <target name="api"
          description="build the API documentation">
    <mkdir dir="${typecheck.api.dir}"/>
    <javadoc
      destdir="${typecheck.api.dir}"
      private="true">
      <packageset dir="${typecheck.src.dir}"/>
      <tag name="czt.todo" description="To do:"/>
      <classpath refid="classpath"/>
    </javadoc>
  </target>
  
   <target name="api-src" depends="api"
    description="generate the jar file with typechecker api doc" >
    <mkdir dir="${typecheck.jar.dir}"/>
    <jar jarfile="${typecheck.api.src.jar.file}">
      <fileset dir="${typecheck.api.dir}"/>
    </jar>
  </target> 

  <target name="run" depends="install" if="file">
    <echo message="Running the typechecker ..."/>
    <java classname="net.sourceforge.czt.typecheck.z.TypeCheckUtils" fork="true">
      <arg value="${file}"/>
      <classpath refid="classpath"/>
      <jvmarg value="-Dczt.home=.."/>
    </java>
  </target>
 
  <target name="test" depends="install"
    description="build and run the tests">
    <ant dir="tests"/>
<!--
    <ant dir="tests" target="test-report"/>
-->
  </target>

  <target name="printclasspath">
      <pathconvert targetos="unix" property="tmp.clspath"
            refid="classpath">
    </pathconvert>
    <echo message="CLASSPATH = ${tmp.clspath}"/>
  </target>


  <target name="checkstyle" description="check java sources">
    <taskdef resource="checkstyletask.properties"
      classpath="${checkstyle.jar}"/>
    <checkstyle config="${czt.home}/devtools/checkstyle.xml">
      <fileset dir="${typecheck.src.dir}"/>
      <formatter type="plain"/>
    </checkstyle>
  </target>

  <target name="clean"
          description="clean up">
    <delete dir="${typecheck.build.dir}"/>
    <delete dir="${typecheck.api.dir}"/>
    <ant dir="tests" target="clean"/>
  </target> 

  <target name="src" depends="compile"
    description="generate the jar file with typechecker source source code" >
    <mkdir dir="${typecheck.jar.dir}"/>
    <jar jarfile="${typecheck.src.jar.file}">
      <fileset dir="${typecheck.src.dir}">       
      </fileset>          
    </jar>
  </target>

  <target name="bin" depends="install"
    description="build the czt typechecker jar file">
    <property name="czt.build.dir" location="../build"/>
    <mkdir dir="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${util.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${corejava.core.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${corejava.oz.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${java_cup.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${session.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${parser.jar.file}" dest="${czt.build.dir}"/>
    <unjar src="${czt.home}/${jar.dir}/${typechecker.jar.file}" dest="${czt.build.dir}"/>
    <copy todir="${czt.build.dir}/czt">
      <fileset dir="${czt.home}/bin/bsh"/>
    </copy>
    <jar jarfile="${czt.home}/${jar.dir}/czt_typecheck.jar" update="true">
      <fileset dir="${czt.build.dir}"/>
      <manifest> 
        <attribute
          name="Main-Class"
          value="net.sourceforge.czt.typecheck.oz.TypeCheckUtils"/>
      </manifest>
    </jar>
    <delete dir="${czt.build.dir}"/>
   </target>
</project>
